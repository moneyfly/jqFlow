/*! jqFlow - v0.0.1 - 2019-11-23
* Copyright (c) 2019 Moneyfly; Licensed MIT */

!function(){var t,i=document,e=window,o=Math,s=(o.round,o.floor,o.ceil,o.max,o.min,o.abs,o.cos,o.sin,o.PI,navigator.userAgent),r=/msie/i.test(s)&&!e.opera,n=(i.documentMode,/AppleWebKit/.test(s),/Firefox/.test(s)),h=!!i.createElementNS&&!!i.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect;n&&parseInt(s.split("Firefox/")[1],10),h||r||i.createElement("canvas").getContext,i.documentElement.ontouchstart;function a(t,i){var e;for(e in t=t||{},i)t[e]=i[e];return t}function p(t,i,e,o){this.defaultOptions={trans:{"line-width":1.5,"line-length":50,"line-color":"black","arrow-end":"classic-wide-long"},text:{"text-margin":8,"font-size":12,font:"normal","font-family":"Helvetica","font-weight":"normal","font-color":"black"}},this.options=merge(this.defaultOptions,o),this.id=e.id,this.paper=t,this.group=this.paper.set(),this.display_nodes=i,this.initialize(e)}function l(t,i,e){this.defaultOptions={text:{"text-margin":18,"font-size":12,font:"normal","font-family":"Helvetica","font-weight":"normal","font-color":"black"},node:{fill:"#fff",stroke:"#ccc","stroke-width":"1",click:null}},this.options=merge(this.defaultOptions,e),this.id=i.id,this.paper=t,this.group=this.paper.set(),this.childBox=null,this.initialize(i)}function d(){this.defaultOptions={chart:{canvasId:"canvas",height:600,width:320,cellpadding:60},theme:{srcPrefix:"./theme/default"}};var t=0<arguments.length&&arguments[0]||{};this.init(t),this.nodes={},this.transitions={},this.nodes_hierarchy={},this.display_nodes={},this.display_trans={}}e.jqFlow={},Array.prototype.indexOf||(Array.prototype.indexOf=function(t){"use strict";if(null===this)throw new TypeError;var i=Object(this),e=i.length>>>0;if(0==e)return-1;var o=0;if(0<arguments.length&&((o=Number(arguments[1]))!=o?o=0:0!==o&&o!=1/0&&o!=-1/0&&(o=(0<o||-1)*Math.floor(Math.abs(o)))),e<=o)return-1;for(var s=0<=o?o:Math.max(e-Math.abs(o),0);s<e;s++)if(s in i&&i[s]===t)return s;return-1}),Array.prototype.lastIndexOf||(Array.prototype.lastIndexOf=function(t){"use strict";if(null===this)throw new TypeError;var i=Object(this),e=i.length>>>0;if(0==e)return-1;var o=e;1<arguments.length&&((o=Number(arguments[1]))!=o?o=0:0!==o&&o!=1/0&&o!=-1/0&&(o=(0<o||-1)*Math.floor(Math.abs(o))));for(var s=0<=o?Math.min(o,e-1):e-Math.abs(o);0<=s;s--)if(s in i&&i[s]===t)return s;return-1}),Array.prototype.remove||(Array.prototype.remove=function(t){"use strict";var i=Object(this),e=i.indexOf(t);i.splice(e,1)}),Array.prototype.diff||(Array.prototype.diff=function(t){"use strict";for(var i=Object(this),e=[],o={},s=0,r=t.length;s<r;s++){var n=t[s];o.hasOwnProperty(n)||(o[n]=n)}for(s=0,r=i.length;s<r;s++){n=i[s];o.hasOwnProperty(n)||e.push(n)}return e.uniq()}),Array.prototype.uniq||(Array.prototype.uniq=function(){"use strict";for(var t=Object(this),i=[],e={},o=0,s=t.length;o<s;o++){var r=t[o];e.hasOwnProperty(r)||(e[r]=r,i.push(r))}return i}),addEvent=function(t,i,e){jQ(t).bind(i,e)},e.jQuery&&(merge=function(){var t=arguments;return jQuery.extend(!0,null,t[0],t[1],t[2],t[3])}),p.prototype={initialize:function(t){this.trans_info=t},render:function(){var t=this.trans_info.from,i=this.trans_info.to,e=this.trans_info.name,o=(this.trans_info.type,this.display_nodes[t]),s=this.display_nodes[i];this.drawLine(o,s,e),this.bindEvent()},drawLine:function(t,i,e){var o,s=t.getX(),r=t.getY(),n=t.getX2(),h=t.getY2(),a=t.getTopAnchor(),p=t.getRightAnchor(),l=t.getBottomAnchor(),d=t.getLeftAnchor(),u=i.getX(),g=i.getY(),f=i.getX2(),c=i.getY2(),x=i.getTopAnchor(),y=i.getRightAnchor(),v=i.getBottomAnchor(),B=i.getLeftAnchor(),w=s<f&&u<n,_=r<c&&g<h,m=h<g,b=c<r,k=f<s,O=n<u,A=(this.options.trans["line-length"],this.options.trans["line-width"]);if(w&&m?o=this.renderLine(this.paper,l,x,e):_&&O?o=this.renderLine(this.paper,p,B,e):_&&k?o=this.renderLine(this.paper,d,y,e):w&&b?o=this.renderLine(this.paper,a,v,e):k?b?o=this.renderLine(this.paper,a,v,e):m&&(o=this.renderLine(this.paper,l,x,e)):O&&(b?o=this.renderLine(this.paper,a,v,e):m&&(o=this.renderLine(this.paper,l,x,e))),!o[0])for(var X=0,L=this.chart.lines.length;X<L;X++)for(var Y=this.chart.lines[X].attr("path"),j=line.attr("path"),N=0,P=Y.length-1;N<P;N++){var C=[];C.push(["M",Y[N][1],Y[N][2]]),C.push(["L",Y[N+1][1],Y[N+1][2]]);for(var z=C[0][1],E=C[0][2],M=C[1][1],R=C[1][2],T=0,F=j.length-1;T<F;T++){var q=[];q.push(["M",j[T][1],j[T][2]]),q.push(["L",j[T+1][1],j[T+1][2]]);var I,S=q[0][1],U=q[0][2],Q=q[1][1],H=q[1][2],W=checkLineIntersection(z,E,M,R,S,U,Q,H);if(W.onLine1&&W.onLine2)I=U===H?Q<S?(I=["L",W.x+2*A,U],j.splice(T+1,0,I),["C",W.x+2*A,U,W.x,U-4*A,W.x-2*A,U]):(I=["L",W.x-2*A,U],j.splice(T+1,0,I),["C",W.x-2*A,U,W.x,U-4*A,W.x+2*A,U]):H<U?(I=["L",S,W.y+2*A],j.splice(T+1,0,I),["C",S,W.y+2*A,S+4*A,W.y,S,W.y-2*A]):(I=["L",S,W.y-2*A],j.splice(T+1,0,I),["C",S,W.y-2*A,S+4*A,W.y,S,W.y+2*A]),j.splice(T+2,0,I),line.attr("path",j),T+=2,2}}},renderLine:function(t,i,e,o){var s,r;"[object Array]"!==Object.prototype.toString.call(e)&&(e=[e]);var n="M{0},{1}";for(r=(s=2)*e.length+2;s<r;s+=2)n+=" L{"+s+"},{"+(s+1)+"}";var h=[i.x,i.y];for(s=0,r=e.length;s<r;s++)h.push(e[s].x),h.push(e[s].y);var a=t.path(n,h);a.attr({stroke:this.options.trans["line-color"],"stroke-width":this.options.trans["line-width"],"arrow-end":this.options.trans["arrow-end"]});var p=this.options.text.font,l=this.options.text["font-family"],d=this.options.text["font-weight"];if(p&&a.attr({font:p}),l&&a.attr({"font-family":l}),d&&a.attr({"font-weight":d}),this.group.push(a),o){var u=t.text(0,0,o),g=!1,f=e[0];i.y===f.y&&(g=!0);var c=0,x=0;c=i.x>f.x?i.x-(i.x-f.x)/2:f.x-(f.x-i.x)/2,x=i.y>f.y?i.y-(i.y-f.y)/2:f.y-(f.y-i.y)/2,g?(c-=u.getBBox().width/2,x-=this.options.text["text-margin"]):(c+=this.options.text["text-margin"],x-=u.getBBox().height/2),u.attr({"text-anchor":"start","font-size":this.options.text["font-size"],fill:this.options.text["font-color"],x:c,y:x}),p&&u.attr({font:p}),l&&u.attr({"font-family":l}),d&&u.attr({"font-weight":d}),u.node.id=this.id,u.node.setAttribute("class","trans-text"),this.group.push(u)}return this.group.attr({cursor:"pointer"}),this.group},bindEvent:function(){if("function"==typeof this.options.trans.click)this.group.click(this.options.trans.click);else if(void 0!==this.options.trans.post&&this.options.trans.post.hasOwnProperty("baseUrl")){var t=this.options.trans.post.baseUrl,i=this.id;this.group.click(function(){jQuery.post(t,{id:i,type:"trans"},function(t){})})}}},l.prototype={initialize:function(t){this.name=t.name,this.nodeType=t.type,this.text=this.paper.text(0,0,function(t,i){var e=t.length;if(e<i)return t;for(var o=0,s=[];o+i<e;)s.push(t.slice(o,o+i)),o+=i;return s.push(t.slice(o,e)),s.join("\n")}(this.name,25)),this.text.attr({fill:this.options.text["font-color"],"font-size":this.options.text["font-size"],font:this.options.text.normal,"font-family":this.options.text.Helvetica,"font-weight":this.options.text.normal,cursor:"pointer"}),this.group.push(this.text);var i,e="",o=this.options.theme.srcPrefix,s=t.status,r=t.outcome;e="completed"!=s?o+"/images/"+s+".png":o+"/images/"+r+".png",this.status=this.paper.image(e,0,0,18,18),this.group.push(this.status);var n={fill:t.disable&&this.options.node.stroke||this.options.node.fill,stroke:this.options.node.stroke,"stroke-width":this.options.node["stroke-width"],cursor:"pointer","fill-opacity":.8,title:t.name};switch(this.nodeType){case"subworkflow":i=this.__workflowNode(n);break;case"subjob":i=this.__actionNode(n);break;case"noaction":i=this.__nullNode(n);break;default:return new Error("Wrong symbol type!")}if(this.group.push(i),i.insertBefore(this.text),this.text.attr({x:i.getBBox().width/2,y:i.getBBox().height/2+this.status.getBBox().height/2}),this.status.attr({x:i.getBBox().width/2-this.status.getBBox().width/2,y:this.status.getBBox().height/2}),"set"==i.type&&1<i.length){var h=i[1];h.attr({x:i.getBBox().width-h.getBBox().width,y:4})}this.group.attr({cursor:"pointer"}),this.width=this.group.getBBox().width,this.height=this.group.getBBox().height+4,this.bindEvent()},__actionNode:function(t){var i=this.text.getBBox().width,e=this.text.getBBox().height,o=this.options.text["text-margin"];a(t,{width:i+3*o,height:e+2*o});var s=this.paper.rect(0,0,0,0);return s.node.id=this.id,s.node.setAttribute("class","node"),s.attr(t),s},__workflowNode:function(t){var i=this.text.getBBox().width,e=this.text.getBBox().height,o=this.options.text["text-margin"];a(t,{width:i+4*o,height:e+2*o});var s=this.paper.rect(0,0,0,0);s.node.id=this.id,s.node.setAttribute("class","node"),s.attr(t);var r=this.options.theme.srcPrefix+"/images/workflow.png",n=this.paper.image(r,0,0,16,16);return this.paper.set().push(s,n)},__nullNode:function(t){var i=this.text.getBBox().width,e=this.text.getBBox().height,o=this.options.text["text-margin"];a(t,{width:i+2*o,height:e+2*o});var s=this.paper.rect(0,0,0,0,36);return s.node.id=this.id,s.node.setAttribute("class","node"),s.attr(t),s},bindEvent:function(){if("function"==typeof this.options.node.click)this.group.click(this.options.node.click);else if(void 0!==this.options.node.post){if(this.options.node.post.hasOwnProperty("baseUrl")){var t=this.options.node.post.baseUrl,i=this.id;this.group.click(function(){jQuery.post(t,{id:i,type:"node"},function(t){})})}}else if(void 0!==this.options.node.get&&this.options.node.get.hasOwnProperty("baseUrl")){t=this.options.node.get.baseUrl,i=this.id;this.group.click(function(){window.open(t+"/"+i,"_blank")})}},getCenter:function(){return{x:this.getX()+this.width/2,y:this.getY()+this.height/2}},__getElemCenter:function(t){return{x:t.getX()+t.width/2,y:t.getY()+t.height/2}},getX:function(){return this.group.getBBox().x},getX2:function(){return this.group.getBBox().x2},getY:function(){return this.group.getBBox().y},getY2:function(){return this.group.getBBox().y2},setChildBox:function(t,i,e,o){null!=t&&null!=i&&null!=e&&null!=o?this.childBox={x:t,y:i,x2:e,y2:o}:null!=this.childBox&&(null==t&&(t=this.childBox.x),null==i&&(i=this.childBox.y),null==e&&(e=this.childBox.x2),null==o&&(o=this.childBox.y2),this.childBox={x:t,y:i,x2:e,y2:o})},shiftX:function(t){this.group.transform("t"+(this.getX()+t)+","+this.getY())},setX:function(t){this.group.transform("t"+t+","+this.getY())},shiftY:function(t){this.group.transform("t"+this.getX()+","+(this.getY()+t))},setY:function(t){this.group.transform("t"+this.getX()+","+t)},shift:function(t,i){this.group.transform("t"+(this.getX()+t)+","+(this.getY()+i))},setRelativeTop:function(t,i,e){var o=t.group.getBBox().x,s=t.group.getBBox().y;this.group.transform("t"+o+","+(s-e))},setRelativeLeft:function(t,i,e){var o=t.group.getBBox().x2,s=t.group.getBBox().y;this.group.transform("t"+(o+i)+","+s)},setRelativeBottom:function(t,i,e){var o=t.group.getBBox().x,s=t.group.getBBox().y2;this.group.transform("t"+o+","+(s+e))},setRelativeRight:function(t,i,e){var o=t.group.getBBox().x,s=t.group.getBBox().y;this.group.transform("t"+(o-i)+","+s)},getTopAnchor:function(){var t=this.getY();return{x:this.getX()+this.width/2,y:t}},getBottomAnchor:function(){var t=this.getY()+this.height;return{x:this.getX()+this.width/2,y:t}},getLeftAnchor:function(){var t=this.getY()+this.group.getBBox().height/2;return{x:this.getX(),y:t}},getRightAnchor:function(){var t=this.getY()+this.group.getBBox().height/2;return{x:this.getX()+this.group.getBBox().width,y:t}}},d.prototype={init:function(t){this.options=merge(this.defaultOptions,t);var i=this.options.chart;this.id=i.id||"jqflow"},parse:function(t){for(var i=0,e=t.workflow.activities.length;i<e;i++){var o=t.workflow.activities[i];this.nodes[o.id]={id:o.id,name:o.name,type:o.subtype,index:o.index,outcome:o.outcome,status:o.status,disable:o.disable}}var s={},r=[];for(i=0,e=t.workflow.transitions.length;i<e;i++){var n=t.workflow.transitions[i];this.transitions[n.id]={id:n.id,name:n.name,type:n.type,from:n.from,to:n.to},s.hasOwnProperty(n.from)||(s[n.from]=[],r.push([n.from,this.nodes[n.from].index])),s[n.from].push(n.to)}r.sort(function(t,i){return t[1]-i[1]});var h=[];for(i=0,e=r.length;i<e;i++)h.push(r[i][0]);this.__build_nodes_hirerarchy(h,this.nodes_hierarchy,s),this.__check_nodes_notin_relationshipset(this.nodes,this.nodes_hierarchy,s)},__check_nodes_notin_relationshipset:function(t,i,e){var o=[];for(var s in t)o.push(s);var r=[];for(var s in e)r.push(s),r=r.concat(e[s]);for(var n=o.diff(r),h=0,a=n.length;h<a;h++)i[n[h]]=null},__build_nodes_hirerarchy:function(t,i,e){for(;0!=t.length;){var o=t.shift(),s=[];"string"==typeof(h=e[o])?s.push(h):"object"==typeof h&&(s=h);for(var r=0,n=s.length;r<n;r++){var h=s[r];-1==t.indexOf(h)?(i.hasOwnProperty(o)||(i[o]={}),i.hasOwnProperty(h)?(i[o][h]=i[h],delete i[h]):i[o][h]=null):(i.hasOwnProperty(o)||(i[o]={}),i[o][h]={},this.__build_sub_hirerarchy(t,i[o],i,[o,h],e))}}},__build_sub_hirerarchy:function(t,i,e,o,s){var r="";0!=o.length?(r=o[o.length-1],t.remove(r)):r=t.shift();var n=[];"string"==typeof(p=s[r])?n.push(p):"object"==typeof p&&(n=p);for(var h=0,a=n.length;h<a;h++){var p=n[h];-1==o.indexOf(p)&&(-1==t.indexOf(p)?(i.hasOwnProperty(r)||(i[r]={}),e.hasOwnProperty(p)?(i[r][p]=e[p],delete e[p]):i[r][p]=null):(i.hasOwnProperty(r)||(i[r]={}),i[r][p]={},o=o.concat([p]),this.__build_sub_hirerarchy(t,i[r],e,o,s)))}},drawFlowChart:function(t){for(var i in this.clean(),this.paper=new Raphael(this.options.chart.canvasId),this.parse(t),this.nodes){var e=this.nodes[i];this.display_nodes[i]=new l(this.paper,e,this.options)}this.render()},clean:function(){this.paper&&(this.nodes={},this.transitions={},this.nodes_hierarchy={},this.display_nodes={},this.display_trans={},this.display_nodes={},this.display_trans={},this.resize(),this.paper.clear())},reloadChart:function(t){this.clean(),this.drawFlowChart(t)},__renderNodes:function(t,i,e){var o,s=0,r=this.options.chart.cellpadding,n=1.5*r;for(var h in t){var a=t[h],p=i[h];0==s?null==e?p.shift(r,r):(p.setRelativeBottom(e,n,n),e.setChildBox(p.getX(),p.getY(),p.getX2(),p.getY2())):(null!=o.childBox&&o.getX2()<o.childBox.x2?n+=o.childBox.x2-o.getX2():n=1.5*r,p.setRelativeLeft(o,n,n),null!=e&&(e.setChildBox(null,null,p.getX2(),p.getY2()),e.shiftX(e.childBox&&(e.childBox.x2-e.getX()-e.width)/2||0))),null!=a&&(this.__renderNodes(a,i,p),null!=e&&null!=p.childBox&&(e.setChildBox(null,null,p.childBox.x2,p.childBox.y2),e.shiftX(e.childBox&&(e.childBox.x2-e.getX()-e.width)/2||0))),o=p,s+=1}},__reviseNodesOffset:function(t){},__renderTransitons:function(t,i,e){for(var o in e){var s=e[o];i[o]=new p(this.paper,t,s,this.options),i[o].render()}},render:function(){var t=this.options.chart.cellpadding,i=0,e=0;for(var o in this.__renderNodes(this.nodes_hierarchy,this.display_nodes,null),this.__reviseNodesOffset(this.display_nodes),this.__renderTransitons(this.display_nodes,this.display_trans,this.transitions),this.display_nodes){var s=this.display_nodes[o];width=s.group.getBBox().x2,i=i<width&&width||i,height=s.group.getBBox().y2,e=e<height&&height||e}for(var o in this.display_trans){var r=this.display_trans[o];width=r.group.getBBox().x2,i=i<width&&width||i,height=r.group.getBBox().y2,e=e<height&&height||e}this.paper.setSize(i+t,e+t)},resize:function(){var t=this.options.chart.cellpadding,i=0,e=0;for(var o in this.display_nodes){var s=this.display_nodes[o];width=s.group.getBBox().x2,i=i<width&&width||i,height=s.group.getBBox().y2,e=e<height&&height||e}for(var o in this.display_trans){var r=this.display_trans[o];width=r.group.getBBox().x2,i=i<width&&width||i,height=r.group.getBBox().y2,e=e<height&&height||e}this.paper.setSize(i+t,e+t)},addNewNode:function(){}},a(jqFlow,{FlowChart:d,product:"jqFlow",version:"1.0.0"})}();